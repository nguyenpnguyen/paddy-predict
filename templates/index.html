<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Paddy Image Analyzer</title>
    <script async src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script async src="https://unpkg.com/htmx.org@2.0.4"></script>
    <style>
      body {
          font-family: 'Inter', sans-serif;
      }
      /* Style for htmx loading indicator */
      .htmx-indicator {
          display: none;
      }
      .htmx-request .htmx-indicator {
          display: inline-block;
      }
      .htmx-request.predict-button {
           /* Optional: Style buttons differently while loading */
           background-color: #a0aec0; /* Gray out button */
           cursor: wait;
      }
       #imagePreview:not([src]) {
          display: none; /* Hide preview if no image is selected */
      }
    </style>
  </head>
  <body class="flex flex-col items-center py-8 px-4 min-h-screen text-gray-800 bg-gray-100">
    <div class="container p-6 mx-auto w-full max-w-md bg-white rounded-lg shadow-xl md:max-w-lg lg:max-w-xl">
      <h1 class="mb-6 text-3xl font-bold text-center text-gray-900">Paddy Image Analyzer</h1>
      <div class="p-6 mb-6 text-center rounded-lg border-2 border-blue-400 border-dashed upload-section">
        <label for="imageInput" class="inline-block py-3 px-6 font-semibold text-white bg-blue-500 rounded-md transition duration-200 ease-in-out cursor-pointer hover:bg-blue-600">
          Select Image
        </label>
        <input type="file" id="imageInput" name="file" accept="image/*" class="hidden">
        <p id="fileName" class="mt-3 text-sm text-gray-600"></p>
        <img id="imagePreview" src="" alt="Image Preview" class="object-contain mx-auto mt-4 max-h-64 rounded-md shadow-md">
      </div>
      <div class="flex flex-col justify-center mb-6 space-y-4 md:flex-row md:space-y-0 md:space-x-4 button-section">
        <button
                class="py-3 px-6 w-full font-semibold text-white bg-green-600 rounded-md transition duration-200 ease-in-out md:w-auto hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed predict-button"
                id="diseaseBtn"
                disabled
                hx-post="/predict/disease/"
                hx-encoding="multipart/form-data"
                hx-target="#results"
                hx-swap="innerHTML"
                hx-indicator="#loadingIndicator"
            >
          Classify Disease
          <span class="ml-2 htmx-indicator">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <svg class="inline-block w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>
        <button
                class="py-3 px-6 w-full font-semibold text-white bg-purple-600 rounded-md transition duration-200 ease-in-out md:w-auto hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed predict-button"
                id="varietyBtn"
                disabled
                hx-post="/predict/variety/"
                hx-encoding="multipart/form-data"
                hx-target="#results"
                hx-swap="innerHTML"
                hx-indicator="#loadingIndicator"
            >
          Classify Variety
          <span class="ml-2 htmx-indicator">
            <svg class="inline-block w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>
        <button
                class="py-3 px-6 w-full font-semibold text-white bg-orange-600 rounded-md transition duration-200 ease-in-out md:w-auto hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed predict-button"
                id="ageBtn"
                disabled
                 hx-post="/predict/age/"
                hx-encoding="multipart/form-data"
                hx-target="#results"
                hx-swap="innerHTML"
                hx-indicator="#loadingIndicator"
            >
          Predict Age
          <span class="ml-2 htmx-indicator">
            <svg class="inline-block w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>
      </div>
      <div id="results" class="flex justify-center items-center p-6 font-semibold text-center text-gray-700 bg-gray-200 rounded-lg results-section min-h-[4rem]">
        Select an image and click a button to see results.
      </div>
      <div id="loadingIndicator" class="mt-4 font-semibold text-center text-blue-600 htmx-indicator">
        Loading...
      </div>
    </div>
    <script>
      const imageInput = document.getElementById('imageInput');
      const imagePreview = document.getElementById('imagePreview');
      const fileNameDisplay = document.getElementById('fileName');
      const predictButtons = document.querySelectorAll('.predict-button');
      const resultsDiv = document.getElementById('results');

      // Function to update UI when an image is selected
      imageInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file) {
              fileNameDisplay.textContent = `Selected file: ${file.name}`;
              const reader = new FileReader();
              reader.onload = function(e) {
                  imagePreview.src = e.target.result;
              }
              reader.readAsDataURL(file);

              // Enable buttons
              predictButtons.forEach(button => button.disabled = false);
              resultsDiv.textContent = 'Image selected. Click a button to analyze.';
              resultsDiv.className = 'flex justify-center items-center p-6 font-semibold text-center text-gray-700 bg-gray-200 rounded-lg results-section min-h-[4rem]'; // Reset styling

          } else {
              fileNameDisplay.textContent = '';
              imagePreview.src = ''; // Clear preview
               // Disable buttons
              predictButtons.forEach(button => button.disabled = true);
              resultsDiv.textContent = 'Select an image and click a button to see results.';
              resultsDiv.className = 'flex justify-center items-center p-6 font-semibold text-center text-gray-700 bg-gray-200 rounded-lg results-section min-h-[4rem]'; // Reset styling
          }
      });

      // Listen for htmx:beforeRequest to attach the file to the form data
      document.body.addEventListener('htmx:beforeRequest', function(event) {
          const file = imageInput.files[0];
          if (file) {
              // Create a new FormData object for this request
              const formData = new FormData();
              formData.append('file', file); // 'file' must match the parameter name in your FastAPI endpoint

              // Replace the request body with the new FormData
              event.detail.parameters = formData;

               // Optional: Update results div to show "Analyzing..." before request
               resultsDiv.textContent = 'Analyzing image...';
               resultsDiv.className = 'flex justify-center items-center p-6 italic font-semibold text-center text-blue-600 bg-gray-200 rounded-lg results-section min-h-[4rem]';
          } else {
              // Prevent the request if no file is selected
              resultsDiv.textContent = 'Please select an image first.';
              resultsDiv.className = 'flex justify-center items-center p-6 font-bold text-center text-red-600 bg-gray-200 rounded-lg results-section min-h-[4rem]';
              event.preventDefault();
          }
      });

      // Listen for htmx:afterRequest to handle the response
      document.body.addEventListener('htmx:afterRequest', function(event) {
           // htmx automatically swaps the target content based on hx-target and hx-swap
           // We can add additional logic here if needed, e.g., parse JSON response
           // and format it differently, but htmx's innerHTML swap is sufficient
           // for displaying the JSON response directly in this case.

           // If the response was an error (e.g., 500 from FastAPI), htmx will put
           // the error response body into the target. We can check for error status
           // and style the results div accordingly.
           if (event.detail.xhr.status >= 400) {
               resultsDiv.className = 'flex justify-center items-center p-6 font-bold text-center text-red-600 bg-red-200 rounded-lg results-section min-h-[4rem]';
           } else {
                // Assuming successful JSON response, htmx puts the JSON string
                // into the results div. We can parse and format it better.
                try {
                    const responseJson = JSON.parse(resultsDiv.textContent);
                    let formattedResult = 'Analysis Result: <br>';
                    if (responseJson.predicted_class) {
                        formattedResult += `Disease: ${responseJson.predicted_class}`;
                    } else if (responseJson.predicted_variety) {
                         formattedResult += `Variety: ${responseJson.predicted_variety}`;
                    } else if (responseJson.predicted_age !== undefined) { // Check for age explicitly
                         formattedResult += `Age: ${responseJson.predicted_age} days`;
                    } else {
                         formattedResult = 'Received unexpected response format.';
                    }
                     resultsDiv.innerHTML = formattedResult; // Use innerHTML to render <br>
                     resultsDiv.className = 'flex justify-center items-center p-6 font-semibold text-center text-green-800 bg-green-200 rounded-lg results-section min-h-[4rem]'; // Success styling

                } catch (e) {
                     // If response is not valid JSON (e.g., plain error message from FastAPI)
                     resultsDiv.className = 'flex justify-center items-center p-6 font-bold text-center text-red-600 bg-red-200 rounded-lg results-section min-h-[4rem]';
                     // The error message from FastAPI's HTTPException detail will likely be in resultsDiv.textContent already
                }
           }
      });
    </script>
  </body>
</html>
